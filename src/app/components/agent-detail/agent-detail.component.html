@if (websiteData()) {
<div class="agent-detail-container">
  <div class="agent-content" *ngIf="agentInfo(); else notFound">
    <button class="back-button" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      <span>Back</span>
    </button>

    <!-- Try Agent Section -->
    <section class="try-agent-landing">
      <div class="search-section">
          <div class="section-header">
            <h2>Research Agent</h2>
            <div class="config-area">
              <span class="config-summary">{{ getConfigSummary() }}</span>
              <button type="button" class="config-button" (click)="openConfigModal()" title="Configuration">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M12 1v6m0 6v6m5.5-14.5l-4.2 4.2m-5.6 5.6l-4.2 4.2M23 12h-6m-6 0H1m20.5-5.5l-4.2 4.2m-5.6 5.6l-4.2 4.2"></path>
                </svg>
              </button>
            </div>
          </div>

          <form (ngSubmit)="submitQuery()" class="query-form">
            <div class="input-group">
              <textarea
                [(ngModel)]="query"
                name="query"
                placeholder="Ask anything..."
                rows="3"
                class="query-input"
                [disabled]="isLoading() || showAnimation()"
              ></textarea>
              <button
                type="submit"
                class="submit-button"
                [disabled]="!query().trim() || isLoading() || showAnimation()"
              >
                @if (!isLoading()) {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
                } @else {
                <div class="mini-spinner"></div>
                }
              </button>
            </div>
          </form>
        </div>

      <!-- Process Animation -->
      @if (showAnimation()) {
      <div class="animation-container">
        <app-process-animation [isVisible]="showAnimation()"></app-process-animation>
      </div>
      }

      <!-- Results Section -->
      @if (result()) {
      <div class="results-section" id="results-section">
        <div class="result-content">
          <div class="summary-section">
            <h3>{{ submittedQuery() || 'Research Summary' }}</h3>
            <div class="markdown-content">
              <markdown [data]="result()?.final_summary"></markdown>
            </div>
          </div>

          @if (result()?.sources?.length) {
          <div class="sources-section">
            <h3>Sources</h3>
            <ul class="sources-list">
              @for (source of result()?.sources; track source.url) {
              <li class="source-item">
                <a [href]="source.url" target="_blank" rel="noopener noreferrer">
                  {{ source.title }}
                </a>
              </li>
              }
            </ul>
          </div>
          }
        </div>
      </div>
      }

    </section>

    <section class="agent-info">
      <div class="info-grid">
        <div class="info-left">
          <div class="info-section">
            <h2>How it Works</h2>
            <p>{{ agentInfo()?.description }}</p>
            @if (agentInfo()?.features) {
            <div class="features">
              <h3>Key Features:</h3>
              <ul>
                @for (feature of agentInfo()?.features; track feature) {
                <li>{{ feature }}</li>
                }
              </ul>
            </div>
            }
          </div>
        </div>

        <div class="info-right">
          @if (agentInfo()?.use_cases) {
          <div class="info-section">
            <h2>Use Cases</h2>
            <div class="use-cases">
              @for (useCase of agentInfo()?.use_cases; track useCase) {
              <div class="use-case-item">{{ useCase }}</div>
              }
            </div>
          </div>
          }

          <div class="info-section">
            <h2>Cost</h2>
            <p>{{ agentInfo()?.cost }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent History Section at the end -->
    @if (history().length > 0) {
    <section class="recent-history-section">
      <h3>Recent Queries</h3>
      <div class="recent-history-list">
        @for (historyItem of history().slice(0, 3); track historyItem.created_at) {
        <div class="recent-history-item" (click)="openHistoryModal(historyItem)">
          <div class="history-query-preview">
            <p>{{ truncateQuery(historyItem.query, 60) }}</p>
          </div>
          <div class="history-date">
            <span>{{ formatDate(historyItem.created_at) }}</span>
          </div>
        </div>
        }
      </div>
      @if (history().length > 3) {
      <button class="view-more-btn" (click)="openAllHistoryModal()">
        View All History
      </button>
      }
    </section>
    }
  </div>

  <ng-template #notFound>
    <div class="not-found">
      <h1>Agent Not Found</h1>
      <p>The requested agent could not be found.</p>
      <button class="back-button" (click)="goBack()">Back to Home</button>
    </div>
  </ng-template>
</div>

<!-- History Modal -->
<app-history-modal
  [historyItem]="selectedHistoryItem()"
  [isVisible]="isModalVisible()"
  (close)="closeHistoryModal()">
</app-history-modal>

<!-- Configuration Modal -->
<app-config-modal
  [isVisible]="isConfigModalVisible()"
  [currentConfig]="currentConfig()"
  (close)="closeConfigModal()"
  (save)="saveConfig($event)">
</app-config-modal>

<!-- All History Modal -->
@if (isAllHistoryModalVisible()) {
<div class="modal-overlay" (click)="closeAllHistoryModal()">
  <div class="all-history-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Query History</h2>
      <button type="button" class="close-button" (click)="closeAllHistoryModal(); $event.stopPropagation()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      @if (isLoadingHistory()) {
      <div class="history-loading">
        <div class="spinner"></div>
        <span>Loading history...</span>
      </div>
      } @else if (historyError()) {
      <div class="history-error">
        <p>{{ historyError() }}</p>
        <button class="retry-button" (click)="loadHistory()">Retry</button>
      </div>
      } @else {
      <div class="history-list">
        @for (historyItem of history(); track historyItem.created_at) {
        <div class="history-item">
          <div class="history-content">
            <div class="history-query">
              <p>{{ truncateQuery(historyItem.query) }}</p>
            </div>
            <div class="history-meta">
              <span class="history-date">{{ formatDate(historyItem.created_at) }}</span>
            </div>
          </div>
          <button class="see-more-button" (click)="openHistoryModal(historyItem); closeAllHistoryModal()">
            See More
          </button>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}
}